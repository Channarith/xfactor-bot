stages:
  - lint
  - test
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

cache:
  paths:
    - .pip-cache/
    - .venv/

.python-setup: &python-setup
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - python -m venv .venv
    - source .venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt

# Linting stage
lint:
  <<: *python-setup
  stage: lint
  script:
    - pip install ruff mypy
    - ruff check src/
    - ruff format --check src/
  allow_failure: true

# Type checking
typecheck:
  <<: *python-setup
  stage: lint
  script:
    - pip install mypy
    - mypy src/ --ignore-missing-imports
  allow_failure: true

# Unit tests
test:
  <<: *python-setup
  stage: test
  script:
    - pip install pytest pytest-asyncio pytest-cov
    - pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t trading-bot:${CI_COMMIT_SHORT_SHA} -f docker/Dockerfile .
    - docker tag trading-bot:${CI_COMMIT_SHORT_SHA} trading-bot:latest
  only:
    - main
    - develop

# Deploy (manual trigger)
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Deploying trading bot..."
    - docker-compose -f docker/docker-compose.yml up -d
  when: manual
  only:
    - main

